q = 2**64 - 2**32 + 1

# 512-th primitive root of unity mod q
# needed to multipy in Z[x]/(x^256+1)

psi_512 = 237214921853999334

# bit reversed arrays of powers of psi_512 and its inverse 

psi_512_rev = [ 1, 18446462594437873665, 1099511627520, 16777216, 68719476736, 18442240469788262401, 18446744069414580225,
1152921504606846976, 262144, 18446744052234715141, 288230376084602880, 4398046511104, 18014398509481984, 64,
18446744068340842497, 70368744161280, 512, 18302628881338728449, 562949953290240, 8589934592, 35184372088832,
16140901060737761281, 18446744069412487169, 137438953440, 134217728, 18446735273321564161, 18446744069414584313,
2251799813685248, 9223372036854775808, 32768, 18446743519658770433, 36028797010575360, 17591917604864, 17592454475776,
18442240469787213841, 18442240469787213809, 18446744065119551490, 4294901759, 18374687574905061377,
18374685375881805825, 4611615648609468416, 4611756386097823744, 18446743794540871745, 18446743794532483137,
18445618152328134657, 1125882726711296, 288230376151712768, 18158513693262873601, 9007061813690368, 9007336691597312,
16140901060200898561, 16140901060200882177, 18446741870357774849, 2198989700608, 562949953421314, 18446181119461163011,
18410715272395620225, 36028797018963840, 18446603334073745409, 18446603329778778113, 17870274521152356353,
576451956076183552, 34360262648, 18446744035055370249, 18035314424752866021, 3328437340319972906, 16105685926854668541,
16933017626115159474, 16329239638270742865, 15113979899245772281, 6562114217670983589, 17311265416183374564,
4299803665592489687, 17330401598553671485, 10382722127243543029, 12053668962110821384, 8340939052496745868,
10561990880479197442, 4644772024090268603, 16192975500896648969, 10708950766175242252, 7059463857684370340,
416595521271101505, 18182056015521604139, 4195631349813649467, 9171943329124577373, 2495058814089251146,
8930739766887302688, 6336932523019185545, 281721071064741919, 3291437157293746400, 10265989416269385394,
9362914843564906265, 2843318466875884251, 16940035449150731648, 8215369291935911999, 5209436881246729393,
12110422903908887252, 9778634991702905054, 4497639551463306333, 12481021517947587610, 13039192753378044028,
5029422726070465669, 17449332314429639298, 10158338780952714962, 8494120110792728509, 14041890976876060974,
5575382163818481237, 18142929134658341675, 1362567150328163374, 7298973816981743824, 17090085178304640863,
10900537202625306992, 2430519478049941168, 7593472940535036657, 15395185741804386692, 7709569171718681254,
16792080670893602455, 10967010099451201909, 5834015391316509212, 17534372342291866343, 14004640413449681173,
13664737158269917819, 13797081185216407910, 10467450029535024137, 15104850399680027611, 10832292272906805046,
6366922389463153702, 237214921853999334, 11917386045977981907, 9770812262840623888, 13183111817796039999,
4406114516091528337, 8187602034452531322, 6045115764991696949, 14918307414590806615, 494216498237666005,
4459017075746761332, 10949047808060940701, 5290167988639048753, 12050543972821699434, 15181754998655957376,
4831070854124318830, 16589430531118646239, 10773575572760153082, 14276112633913910454, 3588235763047079665,
16691665375249202323, 5427855770283221382, 4641337882585395997, 14493012083513256281, 1221351532855077986,
13231174195295398387, 14067222244347930501, 16549024694582589649, 15341376048663650670, 8665994900238946994,
6979306088310177371, 1644572010096941946, 8286160002038086708, 743439328957095187, 16774647971309520093,
10006174791165856646, 2415297291837877958, 5602886161730919912, 3373377623857539246, 17032024114559111334,
5163568085532294797, 16755100833091933884, 1573035775395650770, 5464760906092500108, 8096577031901772269,
14780429931651188987, 10686628914424923326, 11441669947107069577, 13205888274518958430, 11706055037741049324,
10883769032692578351, 13413385849078745835, 700360770216364989, 9432384046970425189, 11622144959503752099,
13533145890581203496, 5862457866249378161, 875634265288439343, 12184322017746068437, 12499229437757822825,
13376768784840513824, 4415056545429189734, 11317759638843783896, 10517142914396393667, 9906467147968854674,
3863141824208378587, 4764679877301742210, 16508747943021518732, 408281368649950045, 12113519742882795430,
5932183857725394514, 3877499600194655066, 526448012694119458, 10094442559346256270, 3200815326405523330,
7721858563281021845, 502012629086366038, 8655137032736432017, 7433403846946633395, 10763480545232365762,
5095456396745892551, 4126998567329314197, 4545880015766881148, 3870163035137971766, 6125875985213995509,
4016101032690928304, 12012107771410162524, 11478179872302871445, 11286965527584982002, 3266250949199600360,
15503969011144524712, 5988353545162139946, 17222793189829815283, 4211584101552955664, 5873491337271928114,
13772306473425142486, 7882761346440596851, 17799792287555502819, 12418052014939319938, 8917938738259842505,
14424608849493817968, 16723337261179401086, 15122929597976639421, 12030096568512274289, 11779090253969091270,
4837070530626986986, 2454730591976115881, 9809941408468046069, 382428689435778886, 16901410098125234092,
13935318169262536835, 17608981172539450419, 17345757166192390690, 802080937612788754, 12362671770314801832,
9638848843637035273, 6702103175001071216, 3059429515486231088, 13754189079328553053, 16643667963227857075,
17255643403020241594, 4716406379463037818, 2443466371579597244, 5175614254872652016, 11336048296972946422,
1999001684679808555, 14439691868389311614, 13787254465881465880, 8143771702088974879 ]

psi_512_inv_rev = [ 1, 281474976710656, 18446744069397807105, 18446742969902956801, 17293822564807737345, 4096, 4503599626321920,
18446744000695107585, 18446673700670423041, 1073741824, 18446744069414584257, 18428729670905102337,
18446739671368073217, 18158513693329981441, 17179869180, 18446744069414322177, 18410715272404008961, 549755813888,
18446744069414551553, 9223372032559808513, 18444492269600899073, 8, 8796093020160, 18446744069280366593,
18446743931975630881, 2097152, 2305843008676823040, 18446708885042495489, 18446744060824649729, 18446181119461294081,
144115188075855872, 18446744069414583809, 34359214072, 18446744035054321673, 17870292113338400769, 576469548262227968,
140739635806208, 140735340838912, 18410715272395620481, 36028797018964096, 562949953421310, 18446181119461163007,
18446741870424883713, 2199056809472, 2305843009213702144, 2305843009213685760, 18437736732722987009,
18437737007600893953, 288230376151710720, 18158513693262871553, 18445618186687873025, 1125917086449664, 274882101184,
274873712576, 13834987683316760577, 13835128420805115905, 72058693532778496, 72056494509522944, 18446744065119682562,
4295032831, 4503599627370512, 4503599627370480, 18446726476960108545, 18446726477496979457, 12079821679951430619,
7614451796507779275, 3341893669734556710, 7979294039879560184, 4649662884198176411, 4782006911144666502,
4442103655964903148, 912371727122717978, 12612728678098075109, 7479733969963382412, 1654663398520981866,
10737174897695903067, 3051558327610197629, 10853271128879547664, 16016224591364643153, 7546206866789277329,
1356658891109943458, 11147770252432840497, 17084176919086420947, 303814934756242646, 12871361905596103084,
4404853092538523347, 9952623958621855812, 8288405288461869359, 997411754984945023, 13417321343344118652,
5407551316036540293, 5965722551466996711, 13949104517951277988, 8668109077711679267, 6336321165505697069,
13237307188167854928, 10231374777478672322, 1506708620263852673, 15603425602538700070, 9083829225849678056,
8180754653145198927, 15155306912120837921, 18165022998349842402, 12109811546395398776, 9516004302527281633,
15951685255325333175, 9274800740290006948, 14251112719600934854, 264688053892980182, 18030148548143482816,
11387280211730213981, 7737793303239342069, 2253768568517935352, 13801972045324315718, 7884753188935386879,
10105805016917838453, 6393075107303762937, 8064021942171041292, 1116342470860912836, 14146940403822094634,
1135478653231209757, 11884629851743600732, 3332764170168812040, 2117504431143841456, 1513726443299424847,
2341058142559915780, 15118306729094611415, 411429644661718300, 10302972367325609442, 4659489603533118441,
4007052201025272707, 16447742384734775766, 7110695772441637899, 13271129814541932305, 16003277697834987077,
13730337689951546503, 1191100666394342727, 1803076106186727246, 4692554990086031268, 15387314553928353233,
11744640894413513105, 8807895225777549048, 6084072299099782489, 17644663131801795567, 1100986903222193631,
837762896875133902, 4511425900152047486, 1545333971289350229, 18064315379978805435, 8636802660946538252,
15992013477438468440, 13609673538787597335, 6667653815445493051, 6416647500902310032, 3323814471437944900,
1723406808235183235, 4022135219920766353, 9528805331154741816, 6028692054475264383, 646951781859081502,
10563982722973987470, 4674437595989441835, 12573252732142656207, 14235159967861628657, 1223950879584769038,
12458390524252444375, 2942775058270059609, 15180493120214983961, 7159778541829602319, 6968564197111712876,
6434636298004421797, 14430643036723656017, 12320868084200588812, 14576581034276612555, 13900864053647703173,
14319745502085270124, 13351287672668691770, 7683263524182218559, 11013340222467950926, 9791607036678152304,
17944731440328218283, 10724885506133562476, 15245928743009060991, 8352301510068328051, 17920296056720464863,
14569244469219929255, 12514560211689189807, 6333224326531788891, 18038462700764634276, 1937996126393065589,
13682064192112842111, 14583602245206205734, 8540276921445729647, 7929601155018190654, 7128984430570800425,
14031687523985394587, 5069975284574070497, 5947514631656761496, 6262422051668515884, 17571109804126144978,
12584286203165206160, 4913598178833380825, 6824599109910832222, 9014360022444159132, 17746383299198219332,
5033358220335838486, 7562975036722005970, 6740689031673534997, 5240855794895625891, 7005074122307514744,
7760115154989660995, 3666314137763395334, 10350167037512812052, 12981983163322084213, 16873708294018933551,
1691643236322650437, 13283175983882289524, 1414719954855472987, 15073366445557045075, 12843857907683664409,
16031446777576706363, 8440569278248727675, 1672096098105064228, 17703304740457489134, 10160584067376497613,
16802172059317642375, 11467437981104406950, 9780749169175637327, 3105368020750933651, 1897719374831994672,
4379521825066653820, 5215569874119185934, 17225392536559506335, 3953731985901328040, 13805406186829188324,
13018888299131362939, 1755078694165381998, 14858508306367504656, 4170631435500673867, 7673168496654431239,
1857313538295938082, 13615673215290265491, 3264989070758626945, 6396200096592884887, 13156576080775535568,
7497696261353643620, 13987726993667822989, 17952527571176918316, 3528436654823777706, 12401628304422887372,
10259142034962052999, 14040629553323055984, 5263632251618544322, 8675931806573960433, 6529358023436602414,
18209529147560584987 ]

def NTT_sb_256(a):
	t = 256
	m = 1
	while m < 256:
		t >>= 1
		for i in range(m):
			j1 = 2 * i * t
			j2 = j1 + t - 1
			S = psi_512_rev[m + i]
			for j in range(j1,j2+1):
				U = a[j]
				V = (a[j + t] * S)%q
				a[j] = (U + V)%q
				a[j + t] = (U - V)%q
		m = 2*m

def INTT_sb_256(a):
	t = 1
	m = 256
	while m > 1:
		j1 = 0
		h = m >> 1
		for i in range(h):
			j2 = j1 + t - 1
			S = psi_512_inv_rev[h + i]
			for j in range(j1,j2+1):
				U = a[j]
				V = a[j + t]
				a[j] = (U + V)%q
				a[j + t] = ((U - V )*S)%q
			j1 = j1 + 2*t
		t <<= 1
		m >>= 1

	#scaling by inverse of N mod q for N = 256
	invN = 18374686475393433601
	for j in range(256): 
		a[j] = (a[j] * invN)%q


# a, b given as arrays of coefficients, note in place a := a*b, b also gets changed
def FastMul_256(a,b):
	NTT_sb_256(a)
	NTT_sb_256(b)

	for j in range(256):
		a[j] = (a[j]*b[j])%q;

	INTT_sb_256(a);


# schoolbook multiply
def schoolbook_mult(a, b):

	c = [0 for _ in range(256)]
	
	for j in range(256):
		for k in range(256):
			i = (j+k)%256
			prod = (a[j]*b[k])%q;
			if i != (j+k):
				prod = -prod
			c[i] = (c[i] + prod)%q;
	return c
		


# sanity checking

N = 256
a = [randint(0,q-1) for _ in range(N)]
b = [randint(0,q-1) for _ in range(N)]

c = schoolbook_mult(a, b)
FastMul_256(a,b)

print("Sanity check :", a == c)

